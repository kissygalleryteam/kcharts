/*! kcharts - v1.3 - 2014-01-04 9:39:16 PM
* Copyright (c) 2014 数据可视化小组; Licensed  */
KISSY.add("gallery/kcharts/1.3/piechart/util",function(l,e,t,i){function n(l){function e(l){for(var x=0,r=l.length;r>x;x++)i.call(l[x])==n?e(l[x]):t.push(l[x])}var t=[],i=Object.prototype.toString,n=i.call(l);return e(l),t}function x(e,t){function i(e,x){for(var r=0,a=e.length;a>r;r++)l.isArray(e[r])?i(e[r],x++):t(e[r])&&(n[x]||(n[x]=[]),n[x].push(e[r]))}var n=[];return i(e,0),n}function r(e,t){function i(e,n){for(var a=0,s=e.length;s>a;a++)if(l.isArray(e[a].data)){var y=n.push(l.mix({},e[a],!0,["label"]));n[y].data=[],i(e[a].data,n[y].data)}else{var o=e[a].data,c=o/r;t(o,c)?n.push(e[a]):x+=e[a].data}}var n=[],x=0,r=o(e);return i(e,n),n.push({label:"其它",data:x}),n}function a(l){function e(l){for(var t,i=[],n=0,x=l.length;x>n;n++)"object"==typeof l[n].data&&i.push(1+e(l[n].data));return t=i.length?Math.max.apply(null,i):0}var t=e(l);return t+1}function s(l,e){for(var t=0,i=0,n=l.length;n>i;i++){var x=e(l[i]);x&&(t+=x)}return t}function y(e){return s(e,function(e){return e.value&&l.isNumber(e.value)?e.value:0})}function o(e){for(var t=0,i=0,n=e.length;n>i;i++)t+=l.isArray(e[i].data)?o(e[i].data):e[i].data;return t}function c(l){function e(l,x,r){for(var a=0,s=l.length;s>a;a++){var y;if(y=r?r:a+1,w(l[a].data)){var c=o(l[a].data);l[a].value=c,i[x]||(i[x]=[]),i[x].push(l[a]),n[y-1]||(n[y-1]=[]),n[y-1].push(l[a]),e(l[a].data,x+1,y)}else{if(l[a].value=l[a].data,i[x]||(i[x]=[]),i[x].push(l[a]),t-1>x){var h=x+1;for(l[a].crossdepth=x;t>h;)i[h]||(i[h]=[]),i[h].push(l[a]),h++}n[y-1]||(n[y-1]=[]),n[y-1].push(l[a])}}}var t,i=[],n=[],x={};return t=a(l),e(l,0),x.groups=i,x.set=n,x}function h(l,e){var t,i=this.el.get("start"),n=this.prev,x=this.el.get("donutIndex");x&&(i=n.el.get("end")),t=i-e,this.el.set("start",i),this.el.set("end",t)}function v(l,t){var i=t.get("rs"),n=[],x=t.get("interval")||2,r=t.get("paper"),a=t.get("cx"),s=t.get("cy"),o=t.get("pathcfg"),c=!!t.get("donut"),v=t.get("initdeg");void 0==v&&(v=90);for(var f=0,d=l.length;d>f;f++)for(var p=r.set(),u=y(l[f]),g=0,_=0,m=l[f].length;m>_;_++){var b,w,k=l[f],C=k[_],L="number"==typeof C.crossdepth;if(!(L&&d-1>f)){b=f?L?0==C.crossdepth?[i[f]]:[i[C.crossdepth-1]+x,i[f]]:[i[f-1]+x,i[f]]:i[f],c&&1==d&&(b=[i[0],i[1]]),C.el=new e({paper:r,cx:a,cy:s,r:b,start:v,end:v-1,pathcfg:o,framedata:C}),w=C.el.get("$path"),p.push(w),C.el.set("group",p),C.el.set("groupLength",d),C.el.set("framedata",C);var S=[];if(L)for(var A=C.crossdepth;d>A;)S.push(A),A++;else S.push(f);C.el.set("groupIndex",S),C.el.set("donutIndex",_),C.el.set("label",C.label||""),n.push(C.el),function(l){C.el.on("mouseout",function(){t.fire("mouseout",{sector:l})}),C.el.on("mouseover",function(){t.fire("mouseover",{sector:l})}),C.el.on("click",function(){t.fire("click",{sector:l})})}(C.el),C.frame=h,C.from||(C.from={}),C.to||(C.to={}),C.percent=C.value/u,C.from.deg=0,C.to.deg=_==m-1?360-g:360*C.percent,g+=360*C.percent,C.prev=_>0?k[_-1]:k[m-1],C.next=m-1>_?k[_+1]:k[0]}}return n}function f(l,e){for(var t=e.get("paper"),i=0,n=l.length;n>i;i++)for(var x=t.set(),r=0,a=l[i].length;a>r;r++){var s=l[i][r],y=s.el,o=y.get("$path");x.push(o),y.set("set",x)}}function d(l){var e;return(!l||0>l||l>1)&&(e=.1),e}function p(l,e,t){if(t||(t=0),l){this.color=l;var n,x,r,a,s,y=i.getRGB(l);n=i.rgb2hsb(y),x=n.h,r=n.s,a=n.b,s=(r-t)/e,this.step=s,this.h=x,this.s=r,this.b=a}}function u(l,e,n){for(var x=(e.get("paper"),e.get("color")),r=new t,a=x&&x.initial,s=a&&i.getRGB(a),y=x&&d(x.min),o=new p(s,n,y),c=0,h=s,v=e.get("gradient"),f=0,u=l.length;u>f;f++)for(var g=l[f][0].color,_=l[f].length,m=new p(g,_),b=0,w=l[f].length;w>b;b++){var k,C=l[f][b],L=C.el,S=L.get("framedata"),A=L.get("$path");if(C.color)k=C.color;else{var M;if(M=m.getColor())k=M;else{var E=o.getColor();k=E?E:r.getColor(f+b).DEFAULT}}L.set("fill",k),A.attr("fill",k);var T=S.gradientcolor||h;v&&A.attr("gradient",c+S.to.deg/2+"-"+T+"-"+k),c+=S.to.deg,h=k}}function g(e){e=x(e,function(l){var e=l.el.get("$path");return l.hide?(e.hide(),!1):(e.show(),!0)});for(var t=0,i=e.length;i>t;t++)for(var n=e[t],r=s(n,function(e){return e.value&&!e.hide&&l.isNumber(e.value)?e.value:0}),a=0,y=0,o=n.length;o>y;y++){var c=n[y];c.el.get("$path"),c.percent=c.value/r,c.to.deg=y==o-1?360-a:360*c.percent,a+=360*c.percent,c.prev=y>0?n[y-1]:n[o-1],c.next=o-1>y?n[y+1]:n[0]}}function _(l){for(l%=360;0>l;)l+=360;return l>=0&&90>=l||l>270&&360>=l?!0:!1}function m(l){var e=c(l.get("data")),t=v(e.groups,l);l.get("color"),l.get("hsb");var i=n(e.groups);return f(e.set,l),u(e.set,l,i.length),{$sectors:t,groups:e.groups,set:e.set,framedata:i}}function b(l,e,t){return t||(t=5),t>Math.abs(l-e)}var w=l.isArray;p.prototype.getColor=function(){var l;return this.color&&(l="hsb("+[this.h,this.s-=this.step,this.b].join(",")+")"),l};var k={initPath:m,fillColor:u,adjustFrameData:g,isRightAngel:_,filterdata:r,closeto:b};return k},{requires:["gallery/kcharts/1.3/piechart/sector","gallery/kcharts/1.1/tools/color/index","gallery/kcharts/1.1/raphael/index"]}),KISSY.add("gallery/kcharts/1.3/piechart/sector",function(l,e){function t(l,e,t,i,n){Math.abs(i-n)>=360&&(n+=.01),i==n&&(n-=.1);var x,r=Math.PI/180,a=(i+n)/2,s=l+t*Math.cos(-a*r),y=l+.5*t*Math.cos(-a*r),o=l+t*Math.cos(-i*r),c=l+t*Math.cos(-n*r),h=e+t*Math.sin(-a*r),v=e+.5*t*Math.sin(-a*r),f=e+t*Math.sin(-i*r),d=e+t*Math.sin(-n*r),p=+(Math.abs(i-n)>180),u=1;return x=["M",l,e,"L",o,f,"A",t,t,0,p,u,c,d,"z"],x.middleangle=a,x.middlex=s,x.middley=h,x.cx=y,x.cy=v,x.A=[o,f],x.B=[c,d],x}function i(l,e,t,i,n,x){Math.abs(n-x)>=360&&(x+=.01),n==x&&(x-=.1);var r=Math.PI/180,a=(n+x)/2,s=l+i*Math.cos(-a*r),y=l+(t+.5*(i-t))*Math.cos(-a*r),o=(l+t*Math.cos(-a*r),l+t*Math.cos(-n*r)),c=l+t*Math.cos(-x*r),h=l+i*Math.cos(-n*r),v=l+i*Math.cos(-x*r),f=e+i*Math.sin(-a*r),d=e+(t+.5*(i-t))*Math.sin(-a*r),p=(e+t*Math.sin(-a*r),e+t*Math.sin(-n*r)),u=e+t*Math.sin(-x*r),g=e+i*Math.sin(-n*r),_=e+i*Math.sin(-x*r),m=["M",h,g,"L",o,p,"A",t,t,0,+(Math.abs(x-n)>180),1,c,u,"L",v,_,"A",i,i,0,+(Math.abs(x-n)>180),0,h,g];return m.middleangle=a,m.middlex=s,m.middley=f,m.cx=y,m.cy=d,m.A=[o,p],m.B=[h,g],m.C=[c,u],m.D=[v,_],m}var n,x={initializer:function(){return this.draw(),this.bindEvent(),this},bindEvent:function(){this.on("afterCxChange",function(){this.draw()}),this.on("afterCyChange",function(){this.draw()}),this.on("afterStartChange",function(){this.draw()}),this.on("afterEndChange",function(){this.draw()}),this.on("afterRChange",function(){this.draw()});var l=this.get("$path"),e=this;l.click(function(){e.fire("click")}),l.mouseout(function(){e.fire("mouseout")}),l.mouseover(function(){e.fire("mouseover")})},unbindEvent:function(){this.detach();var l=this.get("$path");l.unclick(),l.unmouseover(),l.unmouseout()},_syncAttrFromPath:function(l){this.set({middleangle:l.middleangle,sectorcx:l.cx,sectorcy:l.cy,middlex:l.middlex,middley:l.middley,centerpoint:l.cc,A:l.A,B:l.B})},draw:function(){var e=this.get("r"),t=this.get("paper"),i=this.get("pathcfg"),n=this.get("framedata"),x=n&&n.sectorcfg||{},r=t.path();i=l.merge({stroke:"#fff"},i),x&&(i=l.merge(i,{stroke:x.stroke,"stroke-width":x.strokeWidth})),r.attr(i),this.set("$path",r),l.isArray(e)&&2==e.length?this._drawDonut():this._drawSector()},_drawSector:function(){var l,e=this.get("cx"),i=this.get("cy"),n=this.get("r"),x=this.get("start"),r=this.get("end"),a=t(e,i,n,x,r),s=a.join(",");return this.get("paper"),l=this.get("$path"),l.attr("path",s),this._syncAttrFromPath(a),this.draw=this._drawSector,this},_drawDonut:function(){var l,e=this.get("cx"),t=this.get("cy"),n=this.get("r"),x=this.get("start"),r=this.get("end");n=n.sort(function(l,e){return e>l?-1:l==e?0:1});var a=i(e,t,n[0],n[1],x,r),s=a.join(",");return this.get("paper"),l=this.get("$path"),l.attr("path",s),this._syncAttrFromPath(a),this.draw=this._drawDonut,this},destroy:function(){this.unbindEvent(),this.get("$path").remove()}};return e.extend?n=e.extend(x):(n=function(l){this.set(l),this.userConfig=l,this.initializer()},l.extend(n,l.Base,x)),n},{requires:["base"]}),KISSY.add("gallery/kcharts/1.3/piechart/label",function(l,e,t,i){function n(l,e){var t,i,n,x;return t=l[0],n=l[1],i=e[0],x=e[1],Math.sqrt(Math.pow(t-i,2)+Math.pow(n-x,2))}function x(l,e,t){function i(l,x,r,a){if(t>=l.length)return{min:r,left:a};if(x>n(e,l[0])){var s=l.slice(1);return i(s,n(e,l[0]),l[0],s)}return i(l.slice(1),x,r,a)}return i(l,1/0,l[0],[])}function r(l,e){function t(l,e,i){if(0==l.length)return i;var n=x(e,l[0],l.length-1);return i.push(n.min),t(l.slice(1),n.left,i)}return t(l,e,[])}function a(l){return s||(s=e("<span/>").css({visibility:"hidden",position:"fixed",left:"-9999em",top:0}).appendTo(document.body)),s.html(l),{width:i.width(s),height:i.height(s)}}var s,y,o={initializer:function(){var l=this.get("label"),e=this.get("x"),t=this.get("y"),i=this.get("size"),n=this.get("pie"),x=(this.get("sector"),n.get("container"));l.css({position:"absolute",left:e+"px",top:t+"px",width:i.width+"px",height:i.height+"px"}).appendTo(x),this.set("el",l)},destroy:function(){this.get("el").remove(),this.get("$path").remove()}};t.extend?y=t.extend(o):(y=function(l){this.set(l),this.userConfig=l,this.initializer()},l.extend(y,t,o));var c,h={initializer:function(){var t,i,n,x,s,o,c,h=this.get("pie"),v=this.get("$sectors"),f=this.get("isleft"),d=h.get("paper"),p=(h.get("container"),v.length,[]),u=[],g=[],_=h.get("cx"),m=h.get("cy"),b=h.get("rs"),w=h.get("padding")||20,k=w+10,C=(Math.cos,Math.sin,Math.asin,Math.PI,Math.PI/180);if(this.labels=[],c=v[0],c&&(t=a(c.get("label")).height)){for(x=Math.max.apply(Math,b),s=x+w,o=x+k,i=m-o,n=m+o,i+=t;n-t>i;i+=t){var L=i,S=Math.asin((L-m)/o),A=_+o*Math.cos(S);A=f?2*_-A:A,p.push([A,L])}v.length>p.length&&(v=v.sort(function(l,e){var t=Math.abs(l.get("start")-l.get("end")),i=Math.abs(e.get("start")-e.get("end"));return t>i?-1:i>t?1:0}),v=v.slice(0,p.length)),v=v.sort(function(l,e){var t=l.get("middley"),i=e.get("middley");return i>t?1:t>i?-1:0}),Math.PI/180,l.each(v,function(l){var e,t,i=l.get("middlex"),n=l.get("middley"),x=l.get("middleangle")*C;e=_+s*Math.cos(-x),t=m+s*Math.sin(-x),g.push([e,t]),u.push([i,n])}),u=u.reverse(),g=g.reverse(),v=v.reverse();for(var M=r(u,p),E=0,T=M.length;T>E;E++){var I,z,P,R,N=u[E],F=M[E];I=N[0],P=N[1],z=F[0],R=F[1];var Z,Y;Z=g[E][0],Y=g[E][1];var O,D=R;O=f?z-10:z+10;var X,G,$,j=d.path(["M",I,P,"Q",Z,Y,O,D].join(",")),B=v[E],U=h.get("sizefn"),H=B.get("label"),q=h.get("labelfn"),V=this,K=B.get("$path").attr("fill"),W=h.get("autoLabelPathColor");q&&l.isFunction(q)&&(H=q(H,B,h)),X=a(H),j&&j.toBack&&j.toBack(),"undefined"!=W&&j.attr("stroke",K),U&&l.isFunction(U)&&(X=U(X,B,h)),f?(G=O-X.width,$=D-X.height/2):(G=O,$=D-X.height/2);var Q=e("<span class='kcharts-label'>"+H+"</span>"),J=new y({label:Q,sector:B,$path:j,x:G,y:$,size:X,pie:h}),le=J.get("el"),ee=function(l,e,t){l.on("click",function(l){V.fire("click",{el:l.currentTarget,label:t,sector:e})})};ee(le,B,J),V.labels.push(J)}}},destroy:function(){l.each(this.labels,function(l){l.destroy()})}};return t.extend?c=t.extend(h):(c=function(l){this.set(l),this.userConfig=l,this.initializer()},l.extend(c,t,h)),c.getSizeOf=a,c},{requires:["node","base","dom"]}),KISSY.add("gallery/kcharts/1.3/piechart/index",function(l,e,t,i,n,x,r,a,s,y){function o(){this.destroy();var l=x(this.get("container"),this.get("width"),this.get("height"));this.set("paper",l),this.initPath(),this.fire("beforeRender");var e=this.get("framedata");this.animate(e)}function c(e){var t,i=this.get("width"),n=this.get("height"),x=Math.min(i,n),r=e.rpadding;e.rs||(r||(r=40,this.set("rpadding",r)),t=x>r?x-r:x,e.rs=[t/2]),l.isNumber(e.cx)||(e.cx=i/2),l.isNumber(e.cy)||(e.cy=n/2),l.isNumber(e.repaintRate)||(e.repaintRate=200),e.donut&&2!=e.rs.length&&(e.donutSize||(e.donutSize=30),e.donutSize>e.rs[0]&&(e.donutSize=e.rs[0]/2),e.rs[1]=e.rs[0]-e.donutSize)}var h,v="{COLOR}",f=function(){var e=l.get(this.get("renderTo")),t=y.width(e),i=y.height(e),n=x(e),r="static"==y.css(e,"position")?!0:!1;this.set({paper:n,width:t,height:i,container:e});var a=this.userConfig;if(this._setupcfg(a),l.isArray(a.rs)||(a.rs=[a.rs]),r&&y.css(e,"position","relative"),this.set(a),this.adjustCfg(),this.adjustData(),this.drawTitle(),0!=a.autoRender){var s=this;setTimeout(function(){s.render()},0)}var o=this.get("tip");o&&0!=o&&this.renderTip()},d={initializer:f,bindEvent:function(){this.on("afterCxChange",function(){this.render()}),this.on("afterCyChange",function(){this.render()}),this.on("afterRsChange",function(){this.render()}),this.on("afterDataChange",function(){this.render()}),s.on(this.get("container"),"mouseleave",function(){this.fire("mouseleave")},this),this.on("afterRender",this.onafterrender,this)},_setupcfg:c,onafterrender:function(){function e(){var e,t=r.get("$sectors");return e=l.map(t,function(l){var e=l.get("$path"),t=e.attr("fill"),i=l.get("framedata"),n=i.label;return{color:t,text:n,$path:e}})}if(!this.legendrendered){this.legendrendered=!0;var t,i,n,r=this,a=this.get("legend");a&&(t=this.get("paper"),i=this.get("container"),n=this.getbbox(),l.use("gallery/kcharts/1.3/legend/index",function(l,s){var y=e(),o={paper:t,container:i,bbox:n,iconAttrHook:function(l){return{fill:y[l].color}},spanAttrHook:function(l){var e=x.getRGB(y[l].color);return{color:e.hex}},config:y},c=new s(l.merge(o,a));r.set("legend",c),r.fire("afterLegendRender")}))}},adjustCfg:function(){var e=this.get("anim"),t=this,i=l.isFunction(e.endframe)&&e.endframe,n=t.get("label");e||(e={duration:0}),e.endframe=function(){0!=n&&t.drawLabel(n),i&&i.call(t),t.fire("afterRender")}},adjustData:function(){var t=this.get("filterfn");if(t&&l.isFunction(t)){var i,n=this.get("data");i=e.filterdata(n,t),this.set("data",i)}},initPath:function(){var l=e.initPath(this);this.set("$sectors",l.$sectors),this.set("groups",l.groups),this.set("set",l.set),this.set("framedata",l.framedata)},render:function(){this.initPath(),this.fire("beforeRender");var e=this.get("framedata");this.animate(e);var t=l.buffer(o,this.get("repaintRate"),this);this.render=t,this.bindEvent()},adjust:function(){var t=this.get("groups").slice(0),i=this.get("framedata");i=l.filter(i,function(l){return!l.hide}),e.adjustFrameData(t,this);var n=this.get("$labels");l.each(n,function(l){l&&l.destroy()}),this.animate(i)},autoResize:function(){var l,t,i,n=this.get("container"),x=y.width(n),r=y.height(n),a=Math.min(x,r),s=this.get("rpadding"),o=this.get("cx"),c=this.get("cy");t=x/2,i=r/2;var h=this.get("titlebbox");h&&(i+=h.height);var v={width:x,height:r};this.set(v),e.closeto(t,o)||this.set("cx",t),e.closeto(i,c)||this.set("cy",i),l=a>s?a-s:a,h&&(l-=h.height);var f,d,p=this.get("donut"),u=this.get("donutSize");if(p)f=l/2,d=u>f?f/2:f-u,this.set("rs",[f,d]);else{var g=this.get("rs");1==g.length&&this.set("rs",[l/2])}},animate:function(l){var e=this,t=this.get("anim");this.isRunning()&&this.stop(),e.fire("beginRender"),this.animateInstance=i.AnimateObject(l,t)},drawTitle:function(){var e,t,i,x=this.get("title");if(x){e=x.content,t=x.offset||[0,10],i=x.align||"center";var r,a,s=n.getSizeOf(e),o=this.get("container"),c=y.width(o);y.height(o),r="left"==i?0:"right"==i?c-s.width:(c-s.width)/2+t[0],a=t[1];var h=l.Node("<div>"+e+"</div>");h.css({top:a+"px",left:r+"px",position:"absolute"}),this.set("title",h),this.set("titlebbox",{left:r,top:a,width:s.width,height:s.height}),h.appendTo(o)}},drawLabel:function(){var t,i,x=[],r=[],a=this.get("$sectors");l.each(a,function(t){var i=t.get("middleangle"),n=t.get("groupLength"),a=t.get("groupIndex"),s=e.isRightAngel(i),y=t.get("framedata");y.hide||(l.indexOf(n-1,a)>-1?s?r.push(t):(t.set("isleft",!0),x.push(t)):s?t.set("isright",!0):t.set("isleft",!0))}),t=new n({pie:this,$sectors:x,isleft:!0}),i=new n({pie:this,$sectors:r,isleft:!1}),t.on("click",this.onLabelClick,this),i.on("click",this.onLabelClick,this),this.set("$labels",[].concat(t,i))},drawSetLabel:function(){},getbbox:function(){var l,e=this.get("rs"),t=e[e.length-1],i=this.get("rpadding")||0,n=this.get("padding")||0,x=this.get("cx"),r=this.get("cy"),a=2*(t+i+n),s=x-a/2,y=r-a/2;return l={width:a,height:a,left:s,top:y}},renderTip:function(e){if(!this.tip&&(e||(e=this.get("tip")),e)){var t=this,i=t.get("container");l.use("gallery/kcharts/1.3/tip/index",function(l,x){var r=t.getbbox();r.x=r.left,r.y=r.top;var a=e.themeCls||"ks-chart-default",s=e.boundryDetect?r:{},y=l.mix(e,{rootNode:i,clsName:a,boundry:s},void 0,void 0,!0),o=new x(y);t.tip=o,t.on("mouseover",function(i){var x=i.sector,r=x.get("middlex"),a=x.get("middley"),s=x.get("framedata"),y=s.label,c=x.get("groupIndex"),h=x.get("donutIndex"),v=s.percent,f=x.get("color");n.getSizeOf(y),v=(100*v).toFixed(2)+"%",l.isFunction(e.template)?o.setContent(e.template.apply(o,[h,c,y,v])):o.renderTemplate(e.template,{donutIndex:h,index:c,label:y,percent:v}),o.fire("move",{x:r,y:a,style:t.processAttr(e.css,f)})},t)})}},processAttr:function(e,t){var i=l.clone(e);for(var n in i)i[n]&&"string"==typeof i[n]&&(i[n]=i[n].replace(v,t));return i},onLabelClick:function(l){this.fire("labelclick",{el:l.el,label:l.label,sector:l.sector})},isRunning:function(){return this.animateInstance&&this.animateInstance.isRunning()},stop:function(){this.animateInstance&&(this.animateInstance.stop(),delete this.animateInstance)},destroy:function(){var e=this.get("$sectors"),t=this.get("$labels"),i=[].concat(e,t);l.each(i,function(l){l&&l.destroy()}),this.set("$sectors",null),this.set("$labels",null),this.get("paper").remove()}};return a.extend?h=a.extend(d):(h=function(l){this.set(l),this.userConfig=l,this.initializer()},l.extend(h,a,d)),h.getSizeOf=n.getSizeOf,h},{requires:["./util","./sector","gallery/kcharts/1.3/animate/index","./label","gallery/kcharts/1.3/raphael/index","gallery/kcharts/1.3/tools/color/index","base","event","dom"]});