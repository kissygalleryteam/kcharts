KISSY.add("gallery/kcharts/1.1/piechart/index",function(q,B,F,G,H,I){function m(c,b){return c.toFixed(void 0==typeof b?b:2)}function w(c,b){return parseFloat(c.toFixed(4))}function E(c){z=(new I({themeCls:c.themeCls}))._colors;this.colorseed=0;this.container=q.get(c.renderTo);this.labelLayer=this.paper=B(q.get(this.container));this.textlabel=new G;this.cfg={};q.mix(this.cfg,J);q.mix(this.cfg,c);this.percentData=this.sectors=null;this.drawSector();this.renderTip()}var l=q.DOM,z,J={labelPadding:20};
q.extend(E,q.Base,{bindEvent:function(){for(var c=this.sectors,b=this,d=this.cfg.data,g=!1,f=null,e=0;e<c.length;e++)(function(a){c[a].mouseover(function(h){g=!0;f&&clearTimeout(f);b.fire("mouseenter",{sector:c[a],data:d[a],index:a})}).mouseout(function(h){g=!1;b.fire("mouseleave",{target:c[a],data:d[a],index:a});f=setTimeout(function(){g||b.tip&&b.tip.hide()},500)}).click(function(h){b.fire("click",{target:c[a],data:d[a],index:a})})})(e)},onend:function(){var c=this.cfg,b=this;c.labelIndside?this.drawInsideLabel():
!1!=c.label&&this.drawLabel();this.bindEvent();setTimeout(function(){b.fire("afterRender")},0)},sectorFull:function(c,b,d,g,f,e){var a=Math.PI/180;e=(g+f)/2;var h=c+d*Math.cos(-e*a),x=c+d*Math.cos(-g*a),n=c+d*Math.cos(-f*a),s=b+d*Math.sin(-e*a),r=b+d*Math.sin(-g*a),a=b+d*Math.sin(-f*a);c=["M",m(c),b,"L",m(x),m(r),"A",d,d,0,+(180<Math.abs(f-g)),1,m(n),m(a),"z"];g>f?(b=g,g=f):b=f;c.middle={from:b,to:g,angel:e,x:h,y:s};return c},sector:function(c,b,d,g,f,e,a){var h=Math.PI/180;a=(f+e)/2;var x=c+d*Math.cos(-a*
h),n=c+d*Math.cos(-f*h),s=c+d*Math.cos(-e*h),r=c+g*Math.cos(-f*h),K=c+g*Math.cos(-e*h);c=b+d*Math.sin(-a*h);var l=b+d*Math.sin(-f*h),q=b+d*Math.sin(-e*h),t=b+g*Math.sin(-f*h);b+=g*Math.sin(-e*h);d=["M",m(r),m(t),"L",m(n),m(l),"A",d,d,0,+(180<Math.abs(e-f)),1,m(s),m(q),"L",m(K),m(b),"A",g,g,0,+(180<Math.abs(e-f)),0,m(r),m(t)];f>e?(g=f,f=e):g=e;d.middle={from:g,to:f,angel:a,x:x,y:c};return d},drawSector:function(){function c(c){c=c.s;for(var f=g.animater?c*r:r,e,u,p=0;p<C;p++)p?(e=u,u=e-360*c*a[p]):
(h=90+360*(a[0]/2),x=90-360*(a[0]/2),e=h+c*(90-h),u=e+c*(x-h)),l=y?d.sector(n,s,f,y,e,u):d.sectorFull(n,s,f,e,u),1==a[p]&&(y?(l[12]=parseFloat(l[12])-0.1,l[l.length-2]=parseFloat(l[l.length-2])+0.1):l[l.length-3]=parseFloat(l[l.length-3])-0.1),m=l.join(" "),v[p]?v[p].attr("path",m):(e=b.path(m),v[p]=e,e=d.getcolor(p,w),v[p].attr({fill:e,stroke:"#fff"}),v[p].percent=a[p]),1===c&&(v[p].middle=l.middle)}var b=this.paper,d=this,g=this.cfg,f=g.data,e=0,a=[],h,x,n=g.cx,s=g.cy,r=g.R,l,m,w=g.colors;this.percentData=
a;for(var t=0;t<f.length;t++)var D=q.isNumber(f[t].data)?f[t].data:parseFloat(f[t].data),e=e+D;for(t=0;t<f.length;t++)a.push(f[t].data/e);var v=d.sectors=[],C=a.length,y=g.r,f={sector:c,r:function(c,g,e){g=c.s;c=g*r;var f,p;for(e=0;e<C;e++)e?(f=p,p=f-360*a[e]):(h=90+360*(a[0]/2),x=90-360*(a[0]/2),f=h+(90-h),p=f+(x-h)),l=d.sectorFull(n,s,c,f,p),m=l.join(" "),v[e]?v[e].attr("path",m):(f=b.path(m),v[e]=f,f=d.getcolor(e),v[e].attr({fill:f,stroke:"#fff"}),v[e].percent=a[e]),1===g&&(v[e].middle=l.middle)}},
e=q.mix({type:"sector"},g.anim),t=q.UA.ie&&8<q.UA.ie&&g.anim||!q.UA.ie&&g.anim,f=f[e.type]||c;t?(e=new F(e),e.on("step",f,this),e.on("end",this.onend,this),e.run()):(f({s:1,t:1}),this.onend())},scaleSector:function(c,b,d,g,f){c.scale(b,d,g,f)},transformSector:function(c,b){if(this.currentTransformedSector!=c){var d,g;b||(b=10);this.currentTransformedSector&&(g=this.currentTransformedSector.middle.angel*Math.PI/180,d=b*Math.cos(g),g=-b*Math.sin(g),this.currentTransformedSector.translate(-d,-g));g=
c.middle.angel*Math.PI/180;d=b*Math.cos(g);g=-b*Math.sin(g);c.animate({transform:"t"+d+","+g},400);this.currentTransformedSector=c}},getLabelXY:function(c,b,d,g){d=this.textlabel.getTextSize(d);c=g?c-d.width:c+5;b-=d.height/2;return{x:w(c),y:w(b)}},drawLabel:function(){for(var c=this.labelLayer,b=this.cfg,d=b.cx,g=b.cy,f=this.sectors,e,a,h=f.length,x=b.data,n=Math.PI/180,s=Math.cos,r=Math.sin,m=Math.asin,q,z,t,D,v,C=b.R,y=b.R+b.labelPadding,B=b.R+2*b.labelPadding/3,k,A=[],u=[],p=0;p<h;p++)e=f[p],
a=e.middle,k={},-90<=a.angel&&90>=a.angel?A.push(k):u.push(k),a=a.angel%360*n,q=w(d+C*s(-a)),z=w(g+C*r(-a)),t=w(d+B*s(-a)),D=w(g+B*r(-a)),v=w(d+y*s(-a)),a=w(g+y*r(-a)),k.i=p,k.x=q,k.y=z,k.x1=t,k.y1=D,k.x2=v,k.y2=a,e.label=k;f=u.length;e=0;Math.round(2*b.R/f);for(l.offset(this.container);f>e;)k=u[e],h=k.y2,a=(h-g)/y,a=1<a?1:-1>a?-1:a,a=Math.PI+m(a),n=w(d+y*s(a)),0<e&&(a=u[e-1],a=a.y3,a-14<h&&(h=a-14)),n-=5,k.x3=n,k.y3=h,r=["M",k.x,k.y,"Q",k.x2,k.y2," ",n,h],a=x[k.i].label,k.text=a,k=this.getLabelXY(n,
h,a,!0),h=l.create('<span class="ks-charts-label"/>'),l.html(h,a),l.css(this.container,"position","relative"),l.css(h,{position:"absolute",left:k.x+"px",top:k.y+"px"}),l.append(h,this.container),k=c.path(r.join(",")),k.toBack(),b.labelline&&b.labelline.attr&&k.attr(b.labelline.attr),e++;u=A.length;f=0;Math.round(2*b.R/u);for(A=A.slice(0);u>f;)k=A[f],h=k.y2,0<u&&(a=A[u-1],a.y3+14>h&&(h=a.y3+14)),a=(h-g)/y,a=1<a?1:-1>a?-1:a,a=m(a),n=w(d+y*s(a)),n+=5,k.x3=n,k.y3=h,r=["M",k.x,k.y,"Q",k.x2,k.y2," ",n,
h,"L"],a=x[k.i].label,k.text=a,k=this.getLabelXY(n,h,a),h=l.create('<span class="ks-charts-label"/>'),l.html(h,a),l.css(this.container,"position","relative"),l.css(h,{position:"absolute",left:k.x+"px",top:k.y+"px"}),l.append(h,this.container),k=c.path(r.join(",")),k.toBack(),b.labelline&&b.labelline.attr&&k.attr(b.labelline.attr),f++},drawInsideLabel:function(){for(var c=this.cfg,b=c.data,d=this.sectors,g=c.cx,f=c.cy,c=c.R,e=0,a=d.length;e<a;e++){var h=b[e].label,m=d[e].middle.angel,n=Math.PI/180,
s=g+0.5*c*Math.cos(-m*n),m=f+0.5*c*Math.sin(-m*n),n=this.textlabel.getTextSize(h),r=l.create('<span class="ks-charts-label"/>');l.text(r,h);s-=0.5*n.width;m-=0.5*n.height;l.css(this.container,"position","relative");l.css(r,{position:"absolute",left:s+"px",top:m+"px"});l.append(r,this.container)}},renderTip:function(){var c=this.cfg.tip,b=this.container,d,g,f,e;c&&c.tpl&&(d=l.offset(b),g=l.outerWidth(b),f=l.outerHeight(b),d=c.boundryDetect?{x:d.left,y:d.top,width:g,height:f}:{},q.mix(c,{rootNode:q.all(b),
boundry:d,autoRender:1}),this.tip=new H(c),e=this.tip.getInstance(),this.on("mouseenter",function(a){var b=a.sector,f=b.middle,g=f.x,f=f.y,d=B.getRGB(b.attr("fill")),m={};q.mix(m,a.data);m.percent=b.percent;b=d.hex;d=parseInt(b.substring(1,3),16);a=parseInt(b.substring(3,5),16);b=parseInt(b.substring(5,7),16);d=parseInt(80*d/100);a=parseInt(80*a/100);b=parseInt(80*b/100);d=255>d?d:255;a=255>a?a:255;b=255>b?b:255;d=1==d.toString(16).length?"0"+d.toString(16):d.toString(16);a=1==a.toString(16).length?
"0"+a.toString(16):a.toString(16);b=1==b.toString(16).length?"0"+b.toString(16):b.toString(16);d="#"+d+a+b;this.tip.renderTemplate(c.tpl,m);l.css(e,{borderColor:d});this.tip.fire("move",{x:g,y:f})},this))},getcolor:function(c,b){var d=b||z;c%=d.length;return b&&b[c]?d[c].DEFAULT:z[c].DEFAULT}});return E},{requires:["gallery/kcharts/1.1/raphael/index","gallery/kcharts/1.1/ft/index","gallery/kcharts/1.1/label/index","gallery/kcharts/1.1/tip/index","../tools/color/index"]});
