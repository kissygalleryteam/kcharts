/*! kcharts - v1.2 - 2013-10-18 5:12:47 PM
* Copyright (c) 2013 数据可视化小组; Licensed  */
KISSY.add("gallery/kcharts/1.2/piechart/util",function(l,e,t,i){function n(l){function e(l){for(var r=0,x=l.length;x>r;r++)i.call(l[r])==n?e(l[r]):t.push(l[r])}var t=[],i=Object.prototype.toString,n=i.call(l);return e(l),t}function r(e,t){function i(e,r){for(var x=0,s=e.length;s>x;x++)l.isArray(e[x])?i(e[x],r++):t(e[x])&&(n[r]||(n[r]=[]),n[r].push(e[x]))}var n=[];return i(e,0),n}function x(e,t){function i(e,n){for(var s=0,a=e.length;a>s;s++)if(l.isArray(e[s].data)){var y=n.push(l.mix({},e[s],!0,["label"]));n[y].data=[],i(e[s].data,n[y].data)}else{var o=e[s].data,c=o/x;t(o,c)?n.push(e[s]):r+=e[s].data}}var n=[],r=0,x=o(e);return i(e,n),n.push({label:"其它",data:r}),n}function s(l){function e(l){for(var t,i=[],n=0,r=l.length;r>n;n++)"object"==typeof l[n].data&&i.push(1+e(l[n].data));return t=i.length?Math.max.apply(null,i):0}var t=e(l);return t+1}function a(l,e){for(var t=0,i=0,n=l.length;n>i;i++){var r=e(l[i]);r&&(t+=r)}return t}function y(e){return a(e,function(e){return e.value&&l.isNumber(e.value)?e.value:0})}function o(e){for(var t=0,i=0,n=e.length;n>i;i++)t+=l.isArray(e[i].data)?o(e[i].data):e[i].data;return t}function c(l){function e(l,r,x){for(var s=0,a=l.length;a>s;s++){var y;if(y=x?x:s+1,w(l[s].data)){var c=o(l[s].data);l[s].value=c,i[r]||(i[r]=[]),i[r].push(l[s]),n[y-1]||(n[y-1]=[]),n[y-1].push(l[s]),e(l[s].data,r+1,y)}else{if(l[s].value=l[s].data,i[r]||(i[r]=[]),i[r].push(l[s]),t-1>r){var h=r+1;for(l[s].crossdepth=r;t>h;)i[h]||(i[h]=[]),i[h].push(l[s]),h++}n[y-1]||(n[y-1]=[]),n[y-1].push(l[s])}}}var t,i=[],n=[],r={};return t=s(l),e(l,0),r.groups=i,r.set=n,r}function h(l,e){var t,i=this.el.get("start"),n=this.prev,r=this.el.get("donutIndex");r&&(i=n.el.get("end")),t=i-e,this.el.set("start",i),this.el.set("end",t)}function v(l,t){var i=t.get("rs"),n=[],r=t.get("interval")||2,x=t.get("paper"),s=t.get("cx"),a=t.get("cy"),o=t.get("pathcfg"),c=!!t.get("donut"),v=t.get("initdeg");void 0==v&&(v=90);for(var d=0,f=l.length;f>d;d++)for(var p=x.set(),g=y(l[d]),u=0,_=0,m=l[d].length;m>_;_++){var b,w,k=l[d],L=k[_],C="number"==typeof L.crossdepth;if(!(C&&f-1>d)){b=d?C?0==L.crossdepth?[i[d]]:[i[L.crossdepth-1]+r,i[d]]:[i[d-1]+r,i[d]]:i[d],c&&1==f&&(b=[i[0],i[1]]),L.el=new e(x,s,a,b,v,v-1,o,L),w=L.el.get("$path"),p.push(w),L.el.set("group",p),L.el.set("groupLength",f),L.el.set("framedata",L);var S=[];if(C)for(var A=L.crossdepth;f>A;)S.push(A),A++;else S.push(d);L.el.set("groupIndex",S),L.el.set("donutIndex",_),L.el.set("label",L.label||""),n.push(L.el),function(l){L.el.on("mouseout",function(){t.fire("mouseout",{sector:l})}),L.el.on("mouseover",function(){t.fire("mouseover",{sector:l})}),L.el.on("click",function(){t.fire("click",{sector:l})})}(L.el),L.frame=h,L.from||(L.from={}),L.to||(L.to={}),L.percent=L.value/g,L.from.deg=0,L.to.deg=_==m-1?360-u:360*L.percent,u+=360*L.percent,L.prev=_>0?k[_-1]:k[m-1],L.next=m-1>_?k[_+1]:k[0]}}return n}function d(l,e){for(var t=e.get("paper"),i=0,n=l.length;n>i;i++)for(var r=t.set(),x=0,s=l[i].length;s>x;x++){var a=l[i][x],y=a.el,o=y.get("$path");r.push(o),y.set("set",r)}}function f(l){var e;return(!l||0>l||l>1)&&(e=.1),e}function p(l,e,t){if(t||(t=0),l){this.color=l;var n,r,x,s,a,y=i.getRGB(l);n=i.rgb2hsb(y),r=n.h,x=n.s,s=n.b,a=(x-t)/e,this.step=a,this.h=r,this.s=x,this.b=s}}function g(l,e,n){for(var r=e.get("paper"),x=e.get("color"),s=new t,a=x&&x.initial,y=a&&i.getRGB(a),o=x&&f(x.min),c=new p(y,n,o),h=0,v=y,d=e.get("gradient"),g=0,u=l.length;u>g;g++)for(var _=(r.set(),l[g][0].color),m=l[g].length,b=new p(_,m),w=0,k=l[g].length;k>w;w++){var L,C=l[g][w],S=C.el,A=S.get("framedata"),M=S.get("$path");if(C.color)L=C.color;else{var T;if(T=b.getColor())L=T;else{var E=c.getColor();L=E?E:s.getColor(g+w).DEFAULT}}M.attr("fill",L);var P=A.gradientcolor||v;d&&M.attr("gradient",h+A.to.deg/2+"-"+P+"-"+L),h+=A.to.deg,v=L}}function u(e){e=r(e,function(l){var e=l.el.get("$path");return l.hide?(e.hide(),!1):(e.show(),!0)});for(var t=0,i=e.length;i>t;t++)for(var n=e[t],x=a(n,function(e){return e.value&&!e.hide&&l.isNumber(e.value)?e.value:0}),s=0,y=0,o=n.length;o>y;y++){var c=n[y];c.el.get("$path"),c.percent=c.value/x,c.to.deg=y==o-1?360-s:360*c.percent,s+=360*c.percent,c.prev=y>0?n[y-1]:n[o-1],c.next=o-1>y?n[y+1]:n[0]}}function _(l){for(l%=360;0>l;)l+=360;return l>=0&&90>=l||l>270&&360>=l?!0:!1}function m(l){var e=c(l.get("data")),t=v(e.groups,l);l.get("color"),l.get("hsb");var i=n(e.groups);return d(e.set,l),g(e.set,l,i.length),{$sectors:t,groups:e.groups,set:e.set,framedata:i}}function b(l,e,t){return t||(t=5),t>Math.abs(l-e)}var w=l.isArray;p.prototype.getColor=function(){var l;return this.color&&(l="hsb("+[this.h,this.s-=this.step,this.b].join(",")+")"),l};var k={initPath:m,fillColor:g,adjustFrameData:u,isRightAngel:_,filterdata:x,closeto:b};return k},{requires:["gallery/kcharts/1.2/piechart/sector","gallery/kcharts/1.1/tools/color/index","gallery/kcharts/1.1/raphael/index"]}),KISSY.add("gallery/kcharts/1.2/piechart/sector",function(l){function e(l,e,t,i,n){Math.abs(i-n)>=360&&(n+=.01),i==n&&(n-=.1);var r,x=Math.PI/180,s=(i+n)/2,a=l+t*Math.cos(-s*x),y=l+.5*t*Math.cos(-s*x),o=l+t*Math.cos(-i*x),c=l+t*Math.cos(-n*x),h=e+t*Math.sin(-s*x),v=e+.5*t*Math.sin(-s*x),d=e+t*Math.sin(-i*x),f=e+t*Math.sin(-n*x),p=+(Math.abs(i-n)>180),g=1;return r=["M",l,e,"L",o,d,"A",t,t,0,p,g,c,f,"z"],r.middleangle=s,r.middlex=a,r.middley=h,r.cx=y,r.cy=v,r.A=[o,d],r.B=[c,f],r}function t(l,e,t,i,n,r){Math.abs(n-r)>=360&&(r+=.01),n==r&&(r-=.1);var x=Math.PI/180,s=(n+r)/2,a=l+i*Math.cos(-s*x),y=l+(t+.5*(i-t))*Math.cos(-s*x),o=(l+t*Math.cos(-s*x),l+t*Math.cos(-n*x)),c=l+t*Math.cos(-r*x),h=l+i*Math.cos(-n*x),v=l+i*Math.cos(-r*x),d=e+i*Math.sin(-s*x),f=e+(t+.5*(i-t))*Math.sin(-s*x),p=(e+t*Math.sin(-s*x),e+t*Math.sin(-n*x)),g=e+t*Math.sin(-r*x),u=e+i*Math.sin(-n*x),_=e+i*Math.sin(-r*x),m=["M",h,u,"L",o,p,"A",t,t,0,+(Math.abs(r-n)>180),1,c,g,"L",v,_,"A",i,i,0,+(Math.abs(r-n)>180),0,h,u];return m.middleangle=s,m.middlex=a,m.middley=d,m.cx=y,m.cy=f,m.A=[o,p],m.B=[h,u],m.C=[c,g],m.D=[v,_],m}function i(l,e,t,n,r,x,s,a){return this instanceof i?(this.set({cx:e,cy:t,r:n,start:r,end:x,pathcfg:s,paper:l,framedata:a}),this.draw(),this.bindEvent(),this):new i(l,e,t,n,r,x,s)}return l.extend(i,l.Base,{bindEvent:function(){this.on("afterCxChange",function(){this.draw()}),this.on("afterCyChange",function(){this.draw()}),this.on("afterStartChange",function(){this.draw()}),this.on("afterEndChange",function(){this.draw()}),this.on("afterRChange",function(){this.draw()});var l=this.get("$path"),e=this;l.click(function(){e.fire("click")}),l.mouseout(function(){e.fire("mouseout")}),l.mouseover(function(){e.fire("mouseover")})},unbindEvent:function(){this.detach();var l=this.get("$path");l.unclick(),l.unmouseover(),l.unmouseout()},_syncAttrFromPath:function(l){this.set({middleangle:l.middleangle,sectorcx:l.cx,sectorcy:l.cy,middlex:l.middlex,middley:l.middley,centerpoint:l.cc,A:l.A,B:l.B})},draw:function(){var e=this.get("r"),t=this.get("paper"),i=this.get("pathcfg"),n=this.get("framedata"),r=n&&n.sectorcfg||{},x=t.path();i=l.merge({stroke:"#fff"},i),r&&(i=l.merge(i,{stroke:r.stroke,"stroke-width":r.strokeWidth})),x.attr(i),this.set("$path",x),l.isArray(e)&&2==e.length?this._drawDonut():this._drawSector()},_drawSector:function(){var l,t=this.get("cx"),i=this.get("cy"),n=this.get("r"),r=this.get("start"),x=this.get("end"),s=e(t,i,n,r,x),a=s.join(",");return this.get("paper"),l=this.get("$path"),l.attr("path",a),this._syncAttrFromPath(s),this.draw=this._drawSector,this},_drawDonut:function(){var l,e=this.get("cx"),i=this.get("cy"),n=this.get("r"),r=this.get("start"),x=this.get("end");n=n.sort(function(l,e){return e>l?-1:l==e?0:1});var s=t(e,i,n[0],n[1],r,x),a=s.join(",");return this.get("paper"),l=this.get("$path"),l.attr("path",a),this._syncAttrFromPath(s),this.draw=this._drawDonut,this},destroy:function(){this.unbindEvent(),this.get("$path").remove()}}),i}),KISSY.add("gallery/kcharts/1.2/piechart/label",function(l){function e(l,e){var t,i,n,r;return t=l[0],n=l[1],i=e[0],r=e[1],Math.sqrt(Math.pow(t-i,2)+Math.pow(n-r,2))}function t(l,t,i){function n(l,r,x,s){if(i>=l.length)return{min:x,left:s};if(r>e(t,l[0])){var a=l.slice(1);return n(a,e(t,l[0]),l[0],a)}return n(l.slice(1),r,x,s)}return n(l,1/0,l[0],[])}function i(l,e){function i(l,e,n){if(0==l.length)return n;var r=t(e,l[0],l.length-1);return n.push(r.min),i(l.slice(1),r.left,n)}return i(l,e,[])}function n(e){return s||(s=l.Node("<span/>").css({visibility:"hidden",position:"fixed",left:"-9999em",top:0}).appendTo(document.body)),s.html(e),{width:a.width(s),height:a.height(s)}}function r(l){this.set(l),this.init()}function x(e,t,x){var s,a,y,o,c,h,v,d=e.get("paper"),f=(e.get("container"),t.length,[]),p=[],g=[],u=e.get("cx"),_=e.get("cy"),m=e.get("rs"),b=e.get("padding")||20,w=b+10,k=(Math.cos,Math.sin,Math.asin,Math.PI,Math.PI/180);if(this.labels=[],v=t[0]){for(s=n(v.get("label")).height,o=Math.max.apply(Math,m),c=o+b,h=o+w,a=_-h,y=_+h,a+=s;y-s>a;a+=s){var L=a,C=Math.asin((L-_)/h),S=u+h*Math.cos(C);S=x?2*u-S:S,f.push([S,L])}t.length>f.length&&(t=t.sort(function(l,e){var t=Math.abs(l.get("start")-l.get("end")),i=Math.abs(e.get("start")-e.get("end"));return t>i?-1:i>t?1:0}),t=t.slice(0,f.length)),t=t.sort(function(l,e){var t=l.get("middley"),i=e.get("middley");return i>t?1:t>i?-1:0}),Math.PI/180,l.each(t,function(l){var e,t,i=l.get("middlex"),n=l.get("middley"),r=l.get("middleangle")*k;e=u+c*Math.cos(-r),t=_+c*Math.sin(-r),g.push([e,t]),p.push([i,n])}),p=p.reverse(),g=g.reverse(),t=t.reverse();for(var A=i(p,f),M=0,T=A.length;T>M;M++){var E,P,Y,I,z=p[M],R=A[M];E=z[0],Y=z[1],P=R[0],I=R[1];var X,N;X=g[M][0],N=g[M][1];var G,F=I;G=x?P-10:P+10;var Z,D,O,$=d.path(["M",E,Y,"Q",X,N,G,F].join(",")),B=t[M],j=e.get("sizefn"),U=B.get("label"),H=e.get("labelfn"),K=this,V=B.get("$path").attr("fill"),q=e.get("autoLabelPathColor");H&&l.isFunction(H)&&(U=H(U,B,e)),Z=n(U),$&&$.toBack&&$.toBack(),"undefined"!=q&&$.attr("stroke",V),j&&l.isFunction(j)&&(Z=j(Z,B,e)),x?(D=G-Z.width,O=F-Z.height/2):(D=G,O=F-Z.height/2);var W=l.Node("<span class='kcharts-label'>"+U+"</span>"),Q=new r({label:W,sector:B,$path:$,x:D,y:O,size:Z,pie:e}),J=Q.get("el"),le=function(l,e,t){l.on("click",function(l){K.fire("click",{el:l.currentTarget,label:t,sector:e})})};le(J,B,Q),K.labels.push(Q)}}}var s,a=l.DOM;return l.extend(r,l.Base,{init:function(){var l=this.get("label"),e=this.get("x"),t=this.get("y"),i=this.get("size"),n=this.get("pie"),r=(this.get("sector"),n.get("container"));l.css({position:"absolute",left:e+"px",top:t+"px",width:i.width+"px",height:i.height+"px"}).appendTo(r),this.set("el",l)},destroy:function(){this.get("el").remove(),this.get("$path").remove()}}),l.extend(x,l.Base,{destroy:function(){l.each(this.labels,function(l){l.destroy()})}}),x.getSizeOf=n,x}),KISSY.add("gallery/kcharts/1.2/piechart/index",function(l,e,t,i,n,r){function x(){this.destroy();var l=r(this.get("container"),this.get("width"),this.get("height"));this.set("paper",l),this.initPath(),this.fire("beforeRender");var e=this.get("framedata");this.animate(e)}function s(e){var t,i=this.get("width"),n=this.get("height"),r=Math.min(i,n),x=e.rpadding;e.rs||(x||(x=40,this.set("rpadding",x)),t=r>x?r-x:r,e.rs=[t/2]),l.isNumber(e.cx)||(e.cx=i/2),l.isNumber(e.cy)||(e.cy=n/2),l.isNumber(e.repaintRate)||(e.repaintRate=200),e.donut&&2!=e.rs.length&&(e.donutSize||(e.donutSize=30),e.donutSize>e.rs[0]&&(e.donutSize=e.rs[0]/2),e.rs[1]=e.rs[0]-e.donutSize)}function a(e){var t=l.get(e.renderTo),i=y.width(t),n=y.height(t),x=r(t),s="static"==y.css(t,"position")?!0:!1;if(this.set({paper:x,width:i,height:n,container:t}),this._setupcfg(e),l.isArray(e.rs)||(e.rs=[e.rs]),s&&y.css(t,"position","relative"),this.set(e),this.adjustCfg(),this.adjustData(),this.drawTitle(),0!=e.autoRender){var a=this;setTimeout(function(){a.render()},0)}}var y=l.DOM,o=l.Event;return l.extend(a,l.Base,{bindEvent:function(){this.on("afterCxChange",function(){this.render()}),this.on("afterCyChange",function(){this.render()}),this.on("afterRsChange",function(){this.render()}),this.on("afterDataChange",function(){this.render()}),o.on(this.get("container"),"mouseleave",function(){this.fire("mouseleave")},this),this.on("afterRender",this.onafterrender,this)},_setupcfg:s,onafterrender:function(){function e(){var e,t=x.get("$sectors");return e=l.map(t,function(l){var e=l.get("$path"),t=e.attr("fill"),i=l.get("framedata"),n=i.label;return{color:t,text:n,$path:e}})}if(!this.legendrendered){this.legendrendered=!0;var t,i,n,x=this,s=this.get("legend");if(s){t=this.get("paper"),i=this.get("container");var a=this.get("rs"),y=a[a.length-1],o=this.get("rpadding")||0,c=this.get("padding")||0,h=this.get("cx"),v=this.get("cy"),d=2*(y+o+c),f=h-d/2,p=v-d/2;n={width:d,height:d,left:f,top:p},l.use("gallery/kcharts/1.2/legend/index",function(l,a){var y=e(),o={paper:t,container:i,bbox:n,iconAttrHook:function(l){return{fill:y[l].color}},spanAttrHook:function(l){var e=r.getRGB(y[l].color);return{color:e.hex}},config:y},c=new a(l.merge(o,s));x.set("legend",c),x.fire("afterLegendRender")})}}},adjustCfg:function(){var e=this.get("anim"),t=this,i=l.isFunction(e.endframe)&&e.endframe,n=t.get("label");e||(e={duration:0}),e.endframe=function(){0!=n&&t.drawLabel(n),i&&i.call(t),t.fire("afterRender")}},adjustData:function(){var t=this.get("filterfn");if(t&&l.isFunction(t)){var i,n=this.get("data");i=e.filterdata(n,t),this.set("data",i)}},initPath:function(){var l=e.initPath(this);this.set("$sectors",l.$sectors),this.set("groups",l.groups),this.set("set",l.set),this.set("framedata",l.framedata)},render:function(){this.initPath(),this.fire("beforeRender");var e=this.get("framedata");this.animate(e);var t=l.buffer(x,this.get("repaintRate"),this);this.render=t,this.bindEvent()},adjust:function(){var t=this.get("groups").slice(0),i=this.get("framedata");i=l.filter(i,function(l){return!l.hide}),e.adjustFrameData(t,this);var n=this.get("$labels");l.each(n,function(l){l&&l.destroy()}),this.animate(i)},autoResize:function(){var l,t,i,n=this.get("container"),r=y.width(n),x=y.height(n),s=Math.min(r,x),a=this.get("rpadding"),o=this.get("cx"),c=this.get("cy");t=r/2,i=x/2;var h=this.get("titlebbox");h&&(i+=h.height);var v={width:r,height:x};this.set(v),e.closeto(t,o)||this.set("cx",t),e.closeto(i,c)||this.set("cy",i),l=s>a?s-a:s,h&&(l-=h.height);var d,f,p=this.get("donut"),g=this.get("donutSize");if(p)d=l/2,f=g>d?d/2:d-g,this.set("rs",[d,f]);else{var u=this.get("rs");1==u.length&&this.set("rs",[l/2])}},animate:function(l){var e=this,t=this.get("anim");this.isRunning()&&this.stop(),e.fire("beginRender"),this.animateInstance=i.AnimateObject(l,t)},drawTitle:function(){var e,t,i,r=this.get("title");if(r){e=r.content,t=r.offset||[0,10],i=r.align||"center";var x,s,a=n.getSizeOf(e),o=this.get("container"),c=y.width(o);y.height(o),x="left"==i?0:"right"==i?c-a.width:(c-a.width)/2+t[0],s=t[1];var h=l.Node("<div>"+e+"</div>");h.css({top:s+"px",left:x+"px",position:"absolute"}),this.set("title",h),this.set("titlebbox",{left:x,top:s,width:a.width,height:a.height}),h.appendTo(o)}},drawLabel:function(){var t,i,r=[],x=[],s=this.get("$sectors");l.each(s,function(t){var i=t.get("middleangle"),n=t.get("groupLength"),s=t.get("groupIndex"),a=e.isRightAngel(i),y=t.get("framedata");y.hide||(l.indexOf(n-1,s)>-1?a?x.push(t):(t.set("isleft",!0),r.push(t)):a?t.set("isright",!0):t.set("isleft",!0))}),t=new n(this,r,!0),i=new n(this,x,!1),t.on("click",this.onLabelClick,this),i.on("click",this.onLabelClick,this),this.set("$labels",[].concat(t,i))},drawSetLabel:function(){},onLabelClick:function(l){this.fire("labelclick",{el:l.el,label:l.label,sector:l.sector})},isRunning:function(){return this.animateInstance&&this.animateInstance.isRunning()},stop:function(){this.animateInstance&&(this.animateInstance.stop(),delete this.animateInstance)},destroy:function(){var e=this.get("$sectors"),t=this.get("$labels"),i=[].concat(e,t);l.each(i,function(l){l&&l.destroy()}),this.set("$sectors",null),this.set("$labels",null),this.get("paper").remove()}}),a.getSizeOf=n.getSizeOf,a},{requires:["./util","./sector","gallery/kcharts/1.2/animate/index","./label","gallery/kcharts/1.1/raphael/index","gallery/kcharts/1.1/tools/color/index"]});