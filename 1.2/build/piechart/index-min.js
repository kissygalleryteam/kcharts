/*! kcharts - v1.2 - 2013-09-10 7:30:10 PM
* Copyright (c) 2013 数据可视化小组; Licensed  */
KISSY.add("gallery/kcharts/1.2/piechart/util",function(l,t,e,i){function r(l){function t(l){for(var n=0,s=l.length;s>n;n++)i.call(l[n])==r?t(l[n]):e.push(l[n])}var e=[],i=Object.prototype.toString,r=i.call(l);return t(l),e}function n(t,e){function i(t,n){for(var s=0,a=t.length;a>s;s++)l.isArray(t[s])?i(t[s],n++):e(t[s])&&(r[n]||(r[n]=[]),r[n].push(t[s]))}var r=[];return i(t,0),r}function s(t,e){function i(t,r){for(var a=0,o=t.length;o>a;a++)if(l.isArray(t[a].data)){var c=r.push(l.mix({},t[a],!0,["label"]));r[c].data=[],i(t[a].data,r[c].data)}else{var h=t[a].data,d=h/s;e(h,d)?r.push(t[a]):n+=t[a].data}}var r=[],n=0,s=h(t);return i(t,r),r.push({label:"其它",data:n}),r}function a(l){function t(l){for(var e,i=[],r=0,n=l.length;n>r;r++)"object"==typeof l[r].data&&i.push(1+t(l[r].data));return e=i.length?Math.max.apply(null,i):0}var e=t(l);return e+1}function o(l,t){for(var e=0,i=0,r=l.length;r>i;i++){var n=t(l[i]);n&&(e+=n)}return e}function c(t){return o(t,function(t){return t.value&&l.isNumber(t.value)?t.value:0})}function h(t){for(var e=0,i=0,r=t.length;r>i;i++)e+=l.isArray(t[i].data)?h(t[i].data):t[i].data;return e}function d(l){function t(l,n,s){for(var a=0,o=l.length;o>a;a++){var c;if(c=s?s:a+1,w(l[a].data)){var d=h(l[a].data);l[a].value=d,i[n]||(i[n]=[]),i[n].push(l[a]),r[c-1]||(r[c-1]=[]),r[c-1].push(l[a]),t(l[a].data,n+1,c)}else{if(l[a].value=l[a].data,i[n]||(i[n]=[]),i[n].push(l[a]),e-1>n){var f=n+1;for(l[a].crossdepth=n;e>f;)i[f]||(i[f]=[]),i[f].push(l[a]),f++}r[c-1]||(r[c-1]=[]),r[c-1].push(l[a])}}}var e,i=[],r=[],n={};return e=a(l),t(l,0),n.groups=i,n.set=r,n}function f(l,t){var e,i=this.el.get("start"),r=this.prev,n=this.el.get("donutIndex");n&&(i=r.el.get("end")),e=i-t,this.el.set("start",i),this.el.set("end",e)}function p(l,e){var i=e.get("rs"),r=[],n=e.get("interval")||2,s=e.get("paper"),a=e.get("cx"),o=e.get("cy"),h=e.get("pathcfg"),d=!!e.get("donut"),p=e.get("initdeg");void 0==p&&(p=90);for(var g=0,u=l.length;u>g;g++)for(var x=s.set(),_=c(l[g]),v=0,y=0,m=l[g].length;m>y;y++){var b,w,k=l[g],L=k[y],C="number"==typeof L.crossdepth;if(!(C&&u-1>g)){b=g?C?0==L.crossdepth?[i[g]]:[i[L.crossdepth-1]+n,i[g]]:[i[g-1]+n,i[g]]:i[g],d&&1==u&&(b=[i[0],i[1]]),L.el=new t(s,a,o,b,p,p-1,h,L),w=L.el.get("$path"),x.push(w),L.el.set("group",x),L.el.set("groupLength",u),L.el.set("framedata",L);var A=[];if(C)for(var S=L.crossdepth;u>S;)A.push(S),S++;else A.push(g);L.el.set("groupIndex",A),L.el.set("donutIndex",y),L.el.set("label",L.label||""),r.push(L.el),function(l){L.el.on("mouseout",function(){e.fire("mouseout",{sector:l})}),L.el.on("mouseover",function(){e.fire("mouseover",{sector:l})}),L.el.on("click",function(){e.fire("click",{sector:l})})}(L.el),L.frame=f,L.from||(L.from={}),L.to||(L.to={}),L.percent=L.value/_,L.from.deg=0,L.to.deg=y==m-1?360-v:360*L.percent,v+=360*L.percent,L.prev=y>0?k[y-1]:k[m-1],L.next=m-1>y?k[y+1]:k[0]}}return r}function g(l,t){for(var e=t.get("paper"),i=0,r=l.length;r>i;i++)for(var n=e.set(),s=0,a=l[i].length;a>s;s++){var o=l[i][s],c=o.el,h=c.get("$path");n.push(h),c.set("set",n)}}function u(l){var t;return(!l||0>l||l>1)&&(t=.1),t}function x(l,t,e){if(e||(e=0),l){this.color=l;var r,n,s,a,o,c=i.getRGB(l);r=i.rgb2hsb(c),n=r.h,s=r.s,a=r.b,o=(s-e)/t,this.step=o,this.h=n,this.s=s,this.b=a}}function _(l,t,r){for(var n=t.get("paper"),s=t.get("color"),a=new e,o=s&&s.initial,c=o&&i.getRGB(o),h=s&&u(s.min),d=new x(c,r,h),f=0,p=c,g=t.get("gradient"),_=0,v=l.length;v>_;_++)for(var y=(n.set(),l[_][0].color),m=l[_].length,b=new x(y,m),w=0,k=l[_].length;k>w;w++){var L,C=l[_][w],A=C.el,S=A.get("framedata"),E=A.get("$path");if(C.color)L=C.color;else{var M;if(M=b.getColor())L=M;else{var T=d.getColor();L=T?T:a.getColor(_+w).DEFAULT}}E.attr("fill",L);var Y=S.gradientcolor||p;g&&E.attr("gradient",f+S.to.deg/2+"-"+Y+"-"+L),f+=S.to.deg,p=L}}function v(t){t=n(t,function(l){var t=l.el.get("$path");return l.hide?(t.hide(),!1):(t.show(),!0)});for(var e=0,i=t.length;i>e;e++)for(var r=t[e],s=o(r,function(t){return t.value&&!t.hide&&l.isNumber(t.value)?t.value:0}),a=0,c=0,h=r.length;h>c;c++){var d=r[c];d.el.get("$path"),d.percent=d.value/s,d.to.deg=c==h-1?360-a:360*d.percent,a+=360*d.percent,d.prev=c>0?r[c-1]:r[h-1],d.next=h-1>c?r[c+1]:r[0]}}function y(l){for(l%=360;0>l;)l+=360;return l>=0&&90>=l||l>270&&360>=l?!0:!1}function m(l){var t=d(l.get("data")),e=p(t.groups,l);l.get("color"),l.get("hsb");var i=r(t.groups);return g(t.set,l),_(t.set,l,i.length),{$sectors:e,groups:t.groups,set:t.set,framedata:i}}function b(l,t,e){return e||(e=5),e>Math.abs(l-t)}var w=l.isArray;x.prototype.getColor=function(){var l;return this.color&&(l="hsb("+[this.h,this.s-=this.step,this.b].join(",")+")"),l};var k={initPath:m,fillColor:_,adjustFrameData:v,isRightAngel:y,filterdata:s,closeto:b};return k},{requires:["gallery/kcharts/1.2/piechart/sector","gallery/kcharts/1.1/tools/color/index","gallery/kcharts/1.1/raphael/index"]}),KISSY.add("gallery/kcharts/1.2/piechart/sector",function(l){function t(l,t,e,i,r){Math.abs(i-r)>=360&&(r+=.01),i==r&&(r-=.1);var n,s=Math.PI/180,a=(i+r)/2,o=l+e*Math.cos(-a*s),c=l+.5*e*Math.cos(-a*s),h=l+e*Math.cos(-i*s),d=l+e*Math.cos(-r*s),f=t+e*Math.sin(-a*s),p=t+.5*e*Math.sin(-a*s),g=t+e*Math.sin(-i*s),u=t+e*Math.sin(-r*s),x=+(Math.abs(i-r)>180),_=1;return n=["M",l,t,"L",h,g,"A",e,e,0,x,_,d,u,"z"],n.middleangle=a,n.middlex=o,n.middley=f,n.cx=c,n.cy=p,n.A=[h,g],n.B=[d,u],n}function e(l,t,e,i,r,n){Math.abs(r-n)>=360&&(n+=.01),r==n&&(n-=.1);var s=Math.PI/180,a=(r+n)/2,o=l+i*Math.cos(-a*s),c=l+(e+.5*(i-e))*Math.cos(-a*s),h=(l+e*Math.cos(-a*s),l+e*Math.cos(-r*s)),d=l+e*Math.cos(-n*s),f=l+i*Math.cos(-r*s),p=l+i*Math.cos(-n*s),g=t+i*Math.sin(-a*s),u=t+(e+.5*(i-e))*Math.sin(-a*s),x=(t+e*Math.sin(-a*s),t+e*Math.sin(-r*s)),_=t+e*Math.sin(-n*s),v=t+i*Math.sin(-r*s),y=t+i*Math.sin(-n*s),m=["M",f,v,"L",h,x,"A",e,e,0,+(Math.abs(n-r)>180),1,d,_,"L",p,y,"A",i,i,0,+(Math.abs(n-r)>180),0,f,v];return m.middleangle=a,m.middlex=o,m.middley=g,m.cx=c,m.cy=u,m.A=[h,x],m.B=[f,v],m.C=[d,_],m.D=[p,y],m}function i(l,t,e,r,n,s,a,o){return this instanceof i?(this.set({cx:t,cy:e,r:r,start:n,end:s,pathcfg:a,paper:l,framedata:o}),this.draw(),this.bindEvent(),this):new i(l,t,e,r,n,s,a)}return l.extend(i,l.Base,{bindEvent:function(){this.on("afterCxChange",function(){this.draw()}),this.on("afterCyChange",function(){this.draw()}),this.on("afterStartChange",function(){this.draw()}),this.on("afterEndChange",function(){this.draw()}),this.on("afterRChange",function(){this.draw()});var l=this.get("$path"),t=this;l.click(function(){t.fire("click")}),l.mouseout(function(){t.fire("mouseout")}),l.mouseover(function(){t.fire("mouseover")})},unbindEvent:function(){this.detach();var l=this.get("$path");l.unclick(),l.unmouseover(),l.unmouseout()},_syncAttrFromPath:function(l){this.set({middleangle:l.middleangle,sectorcx:l.cx,sectorcy:l.cy,middlex:l.middlex,middley:l.middley,centerpoint:l.cc,A:l.A,B:l.B})},draw:function(){var t=this.get("r"),e=this.get("paper"),i=this.get("pathcfg"),r=this.get("framedata"),n=r&&r.sectorcfg||{},s=e.path();i=l.merge({stroke:"#fff"},i),n&&(i=l.merge(i,{stroke:n.stroke,"stroke-width":n.strokeWidth})),s.attr(i),this.set("$path",s),l.isArray(t)&&2==t.length?this._drawDonut():this._drawSector()},_drawSector:function(){var l,e=this.get("cx"),i=this.get("cy"),r=this.get("r"),n=this.get("start"),s=this.get("end"),a=t(e,i,r,n,s),o=a.join(",");return this.get("paper"),l=this.get("$path"),l.attr("path",o),this._syncAttrFromPath(a),this.draw=this._drawSector,this},_drawDonut:function(){var l,t=this.get("cx"),i=this.get("cy"),r=this.get("r"),n=this.get("start"),s=this.get("end");r=r.sort(function(l,t){return t>l?-1:l==t?0:1});var a=e(t,i,r[0],r[1],n,s),o=a.join(",");return this.get("paper"),l=this.get("$path"),l.attr("path",o),this._syncAttrFromPath(a),this.draw=this._drawDonut,this},destroy:function(){this.unbindEvent(),this.get("$path").remove()}}),i}),KISSY.add("gallery/kcharts/1.2/piechart/label",function(l){function t(l,t){var e,i,r,n;return e=l[0],r=l[1],i=t[0],n=t[1],Math.sqrt(Math.pow(e-i,2)+Math.pow(r-n,2))}function e(l,e,i){function r(l,n,s,a){if(i>=l.length)return{min:s,left:a};if(n>t(e,l[0])){var o=l.slice(1);return r(o,t(e,l[0]),l[0],o)}return r(l.slice(1),n,s,a)}return r(l,1/0,l[0],[])}function i(l,t){function i(l,t,r){if(0==l.length)return r;var n=e(t,l[0],l.length-1);return r.push(n.min),i(l.slice(1),n.left,r)}return i(l,t,[])}function r(t){return a||(a=l.Node("<span/>").css({visibility:"hidden",position:"fixed",left:"-9999em",top:0}).appendTo(document.body)),a.html(t),{width:o.width(a),height:o.height(a)}}function n(l){this.set(l),this.init()}function s(t,e,s){var a,o,c,h,d,f,p,g=t.get("paper"),u=(t.get("container"),e.length,[]),x=[],_=[],v=t.get("cx"),y=t.get("cy"),m=t.get("rs"),b=t.get("padding")||20,w=b+10,k=(Math.cos,Math.sin,Math.asin,Math.PI,Math.PI/180);if(this.labels=[],p=e[0]){for(a=r(p.get("label")).height,h=Math.max.apply(Math,m),d=h+b,f=h+w,o=y-f,c=y+f,o+=a;c-a>o;o+=a){var L=o,C=Math.asin((L-y)/f),A=v+f*Math.cos(C);A=s?2*v-A:A,u.push([A,L])}e.length>u.length&&(e=e.sort(function(l,t){var e=Math.abs(l.get("start")-l.get("end")),i=Math.abs(t.get("start")-t.get("end"));return e>i?-1:i>e?1:0}),e=e.slice(0,u.length)),e=e.sort(function(l,t){var e=l.get("middley"),i=t.get("middley");return i>e?1:e>i?-1:0}),Math.PI/180,l.each(e,function(l){var t,e,i=l.get("middlex"),r=l.get("middley"),n=l.get("middleangle")*k;t=v+d*Math.cos(-n),e=y+d*Math.sin(-n),_.push([t,e]),x.push([i,r])}),x=x.reverse(),_=_.reverse(),e=e.reverse();for(var S=i(x,u),E=0,M=S.length;M>E;E++){var T,Y,P,I,X=x[E],B=S[E];T=X[0],P=X[1],Y=B[0],I=B[1];var F,z;F=_[E][0],z=_[E][1];var N,R=I;N=s?Y-10:Y+10;var G,D,Z,O=g.path(["M",T,P,"Q",F,z,N,R].join(",")),$=e[E],j=t.get("sizefn"),U=$.get("label"),H=t.get("labelfn"),K=this,V=$.get("$path").attr("fill"),q=t.get("autoLabelPathColor");H&&l.isFunction(H)&&(U=H(U,$,t)),G=r(U),O&&O.toBack&&O.toBack(),"undefined"!=q&&O.attr("stroke",V),j&&l.isFunction(j)&&(G=j(G,$,t)),s?(D=N-G.width,Z=R-G.height/2):(D=N,Z=R-G.height/2);var W=l.Node("<span class='kcharts-label'>"+U+"</span>"),Q=new n({label:W,sector:$,$path:O,x:D,y:Z,size:G,pie:t}),J=Q.get("el"),lt=function(l,t,e){l.on("click",function(l){K.fire("click",{el:l.currentTarget,label:e,sector:t})})};lt(J,$,Q),K.labels.push(Q)}}}var a,o=l.DOM;return l.extend(n,l.Base,{init:function(){var l=this.get("label"),t=this.get("x"),e=this.get("y"),i=this.get("size"),r=this.get("pie"),n=(this.get("sector"),r.get("container"));l.css({position:"absolute",left:t+"px",top:e+"px",width:i.width+"px",height:i.height+"px"}).appendTo(n),this.set("el",l)},destroy:function(){this.get("el").remove(),this.get("$path").remove()}}),l.extend(s,l.Base,{destroy:function(){l.each(this.labels,function(l){l.destroy()})}}),s.getSizeOf=r,s}),KISSY.add("gallery/kcharts/1.2/piechart/index",function(l,t,e,i,r,n){function s(){this.destroy();var l=n(this.get("container"),this.get("width"),this.get("height"));this.set("paper",l),this.initPath(),this.fire("beforeRender");var t=this.get("framedata");this.animate(t)}function a(t){var e,i=this.get("width"),r=this.get("height"),n=Math.min(i,r),s=t.rpadding;t.rs||(s||(s=40,this.set("rpadding",s)),e=n>s?n-s:n,t.rs=[e/2]),l.isNumber(t.cx)||(t.cx=i/2),l.isNumber(t.cy)||(t.cy=r/2),l.isNumber(t.repaintRate)||(t.repaintRate=200),t.donut&&2!=t.rs.length&&(t.donutSize||(t.donutSize=30),t.donutSize>t.rs[0]&&(t.donutSize=t.rs[0]/2),t.rs[1]=t.rs[0]-t.donutSize)}function o(t){var e=l.get(t.renderTo),i=c.width(e),r=c.height(e),s=n(e),a="static"==c.css(e,"position")?!0:!1;if(this.set({paper:s,width:i,height:r,container:e}),this._setupcfg(t),l.isArray(t.rs)||(t.rs=[t.rs]),a&&c.css(e,"position","relative"),this.set(t),this.adjustCfg(),this.adjustData(),this.drawTitle(),0!=t.autoRender){var o=this;setTimeout(function(){o.render()},0)}}var c=l.DOM,h=l.Event;return l.extend(o,l.Base,{bindEvent:function(){this.on("afterCxChange",function(){this.render()}),this.on("afterCyChange",function(){this.render()}),this.on("afterRsChange",function(){this.render()}),this.on("afterDataChange",function(){this.render()}),h.on(this.get("container"),"mouseleave",function(){this.fire("mouseleave")},this),this.on("afterRender",this.onafterrender,this)},_setupcfg:a,onafterrender:function(){function t(){var t,e=s.get("$sectors");return t=l.map(e,function(l){var t=l.get("$path"),e=t.attr("fill"),i=l.get("framedata"),r=i.label;return{color:e,text:r,$path:t}})}if(!this.legendrendered){this.legendrendered=!0;var e,i,r,s=this,a=this.get("legend");if(a){e=this.get("paper"),i=this.get("container");var o=this.get("rs"),c=o[o.length-1],h=this.get("rpadding")||0,d=this.get("padding")||0,f=this.get("cx"),p=this.get("cy"),g=2*(c+h+d),u=f-g/2,x=p-g/2;r={width:g,height:g,left:u,top:x},l.use("gallery/kcharts/1.2/legend/index",function(l,o){var c=t(),h={paper:e,container:i,bbox:r,iconAttrHook:function(l){return{fill:c[l].color}},spanAttrHook:function(l){var t=n.getRGB(c[l].color);return{color:t.hex}},config:c},d=new o(l.merge(h,a));s.set("legend",d),s.fire("afterLegendRender")})}}},adjustCfg:function(){var t=this.get("anim"),e=this,i=l.isFunction(t.endframe)&&t.endframe,r=e.get("label");t||(t={duration:0}),t.endframe=function(){0!=r&&e.drawLabel(r),i&&i.call(e),e.fire("afterRender")}},adjustData:function(){var e=this.get("filterfn");if(e&&l.isFunction(e)){var i,r=this.get("data");i=t.filterdata(r,e),this.set("data",i)}},initPath:function(){var l=t.initPath(this);this.set("$sectors",l.$sectors),this.set("groups",l.groups),this.set("set",l.set),this.set("framedata",l.framedata)},render:function(){this.initPath(),this.fire("beforeRender");var t=this.get("framedata");this.animate(t);var e=l.buffer(s,this.get("repaintRate"),this);this.render=e,this.bindEvent()},adjust:function(){var e=this.get("groups").slice(0),i=this.get("framedata");i=l.filter(i,function(l){return!l.hide}),t.adjustFrameData(e,this);var r=this.get("$labels");l.each(r,function(l){l&&l.destroy()}),this.animate(i)},autoResize:function(){var l,e,i,r=this.get("container"),n=c.width(r),s=c.height(r),a=Math.min(n,s),o=this.get("rpadding"),h=this.get("cx"),d=this.get("cy");e=n/2,i=s/2;var f=this.get("titlebbox");f&&(i+=f.height);var p={width:n,height:s};this.set(p),t.closeto(e,h)||this.set("cx",e),t.closeto(i,d)||this.set("cy",i),l=a>o?a-o:a,f&&(l-=f.height);var g,u,x=this.get("donut"),_=this.get("donutSize");if(x)g=l/2,u=_>g?g/2:g-_,this.set("rs",[g,u]);else{var v=this.get("rs");1==v.length&&this.set("rs",[l/2])}},animate:function(l){var t=this,e=this.get("anim");this.isRunning()&&this.stop(),t.fire("beginRender"),this.animateInstance=i.AnimateObject(l,e)},drawTitle:function(){var t,e,i,n=this.get("title");if(n){t=n.content,e=n.offset||[0,10],i=n.align||"center";var s,a,o=r.getSizeOf(t),h=this.get("container"),d=c.width(h);c.height(h),s="left"==i?0:"right"==i?d-o.width:(d-o.width)/2+e[0],a=e[1];var f=l.Node("<div>"+t+"</div>");f.css({top:a+"px",left:s+"px",position:"absolute"}),this.set("title",f),this.set("titlebbox",{left:s,top:a,width:o.width,height:o.height}),f.appendTo(h)}},drawLabel:function(){var e,i,n=[],s=[],a=this.get("$sectors");l.each(a,function(e){var i=e.get("middleangle"),r=e.get("groupLength"),a=e.get("groupIndex"),o=t.isRightAngel(i),c=e.get("framedata");c.hide||(l.indexOf(r-1,a)>-1?o?s.push(e):(e.set("isleft",!0),n.push(e)):o?e.set("isright",!0):e.set("isleft",!0))}),e=new r(this,n,!0),i=new r(this,s,!1),e.on("click",this.onLabelClick,this),i.on("click",this.onLabelClick,this),this.set("$labels",[].concat(e,i))},drawSetLabel:function(){},onLabelClick:function(l){this.fire("labelclick",{el:l.el,label:l.label,sector:l.sector})},isRunning:function(){return this.animateInstance&&this.animateInstance.isRunning()},stop:function(){this.animateInstance&&(this.animateInstance.stop(),delete this.animateInstance)},destroy:function(){var t=this.get("$sectors"),e=this.get("$labels"),i=[].concat(t,e);l.each(i,function(l){l&&l.destroy()}),this.set("$sectors",null),this.set("$labels",null),this.get("paper").remove()}}),o.getSizeOf=r.getSizeOf,o},{requires:["./util","./sector","gallery/kcharts/1.2/animate/index","./label","gallery/kcharts/1.1/raphael/index","gallery/kcharts/1.1/tools/color/index"]});