/*! kcharts - v1.2 - 2013-10-10 10:58:28 AM
* Copyright (c) 2013 数据可视化小组; Licensed  */
KISSY.add("gallery/kcharts/1.2/gallery/funnel/index",function(t,e,l,i,r,n){function s(e,l){l&&(this.content=e,this.config=t.mix(o,l),this.paper=new r(this.content.replace("#","")),this.init())}var a=e.all,o={chart:{type:"funnel",marginRight:100},title:{text:"漏斗",color:"#274b6d"},plotOptions:{series:{dataLabels:{format:"<h4>{{title}}</h4>{{title}}:{{pointer}}"},neckWidth:"50%",neckHeight:"50%"}},legend:{enabled:!1},series:[{name:"",data:[]}]};return t.augment(s,l,{setConfig:function(){var t=parseInt(this.config.plotOptions.series.neckWidth)/100,e=parseInt(this.config.plotOptions.series.neckHeight)/100,l=a(this.content).width()-this.config.chart.marginRight,i=0,r=a(this.content).height();0==e&&(e=1),this.set("width",l),this.set("height",r-i-50),this.set("top",i),this.set("bottom",(l-l*t)/2),this.set("neckHeight",e*(r-i-50))},_title:function(){var t=this.config.title,e=a("<h2></h2>").html(t.text).css({display:"block",position:"absolute",fontSize:14,fontFamily:"Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif",left:t.x,top:-50,height:50,lineHeight:"50px",width:this.get("width"),textAlign:"center",color:t.color});e.appendTo(this.content)},_requsestArry:function(e){var l=this,i=[],r=0;return t.each(e,function(t){r+=t}),0!=r?t.each(e,function(t){i.push(t/r*l.get("height"))}):i=[0],i},_total:function(e){var l=0,i=[],r=this;return t.each(e,function(t){l+=t[1]}),t.each(e,function(t){i.push(t[1]/l*r.get("height"))}),i},_path:function(e){var l=this,i=this.get("width"),r=this.get("top"),n=this.get("bottom"),s=this.get("height"),a=this.get("neckHeight")+r,o=r,c=r;return zuC=this.config.plotOptions.background,num=l._nowNum(e),0==e[0]&&1==e.length?(l.destroy(),void 0):(t.each(e,function(t,e){c+=t;var r=l._countPage(o),h=l._countPage(t);num>e?l.paper.path("M"+r+","+o+"L"+(i-r)+","+o+"L"+(i-r-h)+","+c+"L"+(r+h)+","+c+"Z").attr({stroke:"#fff",fill:zuC[e],"stroke-width":1}):e==num?a==s?l.paper.path("M"+n+","+o+"L"+(i-n)+","+o+"L"+(i-n)+","+c+"L"+n+","+c+"Z").attr({stroke:"#fff",fill:zuC[e],"stroke-width":1}):l.paper.path("M"+r+","+o+"L"+(i-r)+","+o+"L"+(i-n)+","+a+"L"+(i-n)+","+c+"L"+n+","+c+"L"+n+","+a+"Z").attr({stroke:"#fff",fill:zuC[e],"stroke-width":1}):(r=n,h=l._countPage(0),l.paper.path("M"+r+","+o+"L"+(i-r)+","+o+"L"+(i-r-h)+","+c+"L"+(r+h)+","+c+"Z").attr({stroke:"#fff",fill:zuC[e],"stroke-width":1})),o+=t}),void 0)},_linePath:function(e){var l=this,i=this.get("width"),r=this.get("bottom"),n=this.get("top"),s=this.get("neckHeight"),a=this.get("height"),o=n,c=n,h=this._nowNum(e);t.each(e,function(t,e){if(0!=t){var x=c+t/2+o-n,y=i-l._countPage(x);(e>h||x>s||s+n==a)&&(y=i-r),l.paper.path("M"+y+","+x+"L"+(y+50)+","+x).attr({stroke:"#000",fill:"#000","stroke-width":.5}),c+=t}})},_nameSeat:function(e){var l=this,i=a(this.content),r=this.config,n=this.config.series[0],s=this.get("width"),o=this.get("bottom"),c=this.get("height"),h=this.get("top"),x=this.get("neckHeight"),y=h,f=h,u=this._nowNum(e);r.plotOptions.background,_html="",t.each(e,function(t,e){if(0!=t){({title:r.series[0].data[e][0],name:r.series[0].name,pointer:l._slice(r.series[0].data[e][1])});var d=f+t/2+y-h,p=s-l._countPage(d);(e>u||d>x||x+h==c)&&(p=s-o);var g='<strong style="font-weight:bold">'+n.data[e][0]+'</strong><span style="font-size:11px">('+l._slice(n.data[e][1])+")</span>";html=a("<div></div>").html(g).attr("data-num",e).addClass("ks-funnel-line").css({fontSize:"11px",left:p+55,top:d-8,fontFamily:"Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif",position:"absolute"}),html.appendTo(i)}f+=t})},_slice:function(t){var e=""+t,l=e.length;return l>3&&(e=e.slice(0,l-3)+","+e.slice(l-3)),e},_nowNum:function(e){var l=this.get("top"),i=l,r=l,n=0,s=this.get("neckHeight")+l;return t.each(e,function(t,e){r+=t,s>i&&r>s&&(n=e),i+=t}),n},_countPage:function(t){var e=this.get("bottom"),l=this.get("neckHeight"),i=t*e/l;return i},_template:function(e){var l="",i=this.get("width"),r=this.config.plotOptions.background,n=(this.config.plotOptions.backgroundHover,this.config.series[0]);t.each(e,function(t,i){var s="display:inline-block;margin-right:5px;width:10px;height:10px;background:"+r[i];l+='<span class="ks-funnel-legend" data-count='+e[i]+" data-num="+i+' style="margin:0 5px;cursor:pointer;color:'+r[i]+'"><i style='+s+"></i>"+n.data[i][0]+"</span>"}),a("<div></div>").addClass("ks-funnel-foot").html(l).css({width:i,position:"absolute",bottom:20,left:0,textAlign:"center"}).appendTo(a(this.content))},destroy:function(){a(this.content).all("svg").empty(),a(".ks-funnel-line")&&a(".ks-funnel-line").remove()},_evt:function(){var e=this,l=this.config,i=l.plotOptions.background,r=l.plotOptions.backgroundHover,s=a(this.content).all("path");this.config.series[0];var o=new n({rootNode:e.content,boundry:{x:0,y:0,width:e.get("width"),height:e.get("height")}});s.on("click",function(l){var i=t.indexOf(this,s),r={toIndex:i,content:l};e.pathClick(r)}),s.on("mousemove",function(n){var c=t.indexOf(this,s);a(this).attr("fill",r[c]);var h={title:l.series[0].data[c][0],name:l.series[0].name,pointer:e._slice(l.series[0].data[c][1])};o.$tip.css({border:"1px "+i[c]+" solid"}),o.renderTemplate(l.plotOptions.series.dataLabels.format,h),o.animateTo(n.offsetX+10,n.offsetY+10,function(){})}),s.on("mouseleave",function(){var e=t.indexOf(this,s);a(this).attr("fill",i[e]),o.hide()})},_event:function(e){var l=this,i=this.config.plotOptions.background;this.config.plotOptions.backgroundHover,a(this.content).all("path"),this.config.series[0],t.Event.delegate(this.content,"click",".ks-funnel-legend",function(t){var r=a(t.currentTarget),n=parseInt(r.attr("data-num"));"1"!=r.attr("data-flag")?(r.attr("data-flag","1"),r.css({color:"#ccc"}),r.all("i").css({background:"#ccc"}),e[n]=0):(r.attr("data-flag","0"),r.css({color:i[n]}),r.all("i").css({background:i[n]}),e[n]=parseFloat(r.attr("data-count"))),l.set("data",l._requsestArry(e)),l._render(l._requsestArry(e))})},_rednderVal:function(){var t=this;t.setConfig(),t._render(t.get("data"))},_render:function(t){this.destroy(),this._path(t),this._linePath(t),this._nameSeat(t),this._evt()},init:function(){a(this.content).css({marginTop:50}),this.setConfig(),this._title(),this.set("data",this._total(this.config.series[0].data)),this._render(this.get("data")),this._template(this.get("data")),this._event(this.get("data"))},pathClick:function(t){var e=this;e.fire("pathClick",t)}}),s},{attach:!1,requires:["node","base","template","gallery/kcharts/1.2/raphael/","gallery/kcharts/1.1/tip/index"]});